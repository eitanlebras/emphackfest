{% extends "base.html" %}

{% block title %}Results â€” SalmonShield{% endblock %}

{% block content %}

    <!-- score panel -->
    <div class="results-panel">
        <h2>Impact Score: {{ impact_score }}/100</h2>
        <p>Risk Level: <span class="risk-badge risk-{{ risk_color }}">{{ risk_color | upper }}</span></p>
    </div>

    <!-- leaflet map fills this div -->
    <div id="results-map"></div>

    <script>
        // data passed from Flask (already JSON)
        var streams = {{ streams_json | safe }};
        var stormwater = {{ stormwater_json | safe }};
        var userLat = {{ lat }};
        var userLon = {{ lon }};

        // create the map centered on the user's location
        var map = L.map('results-map').setView([userLat, userLon], 14);

        // add the base tile layer (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // mark the user's location
        L.marker([userLat, userLon]).addTo(map)
            .bindPopup("Your location").openPopup();

        // draw each salmon stream, colored by risk
        streams.forEach(function(feature) {
            L.geoJSON(feature, {
                style: function() {
                    // use the riskColor we set in Python (red/yellow/green)
                    return { color: feature.properties.riskColor || "blue", weight: 3 };
                }
            }).addTo(map);
        });

        // draw stormwater discharge points as circle markers
        stormwater.forEach(function(feature) {
            // each feature is a GeoJSON object with geometry.coordinates
            var coords = feature.geometry && feature.geometry.coordinates;
            if (coords) {
                L.circleMarker([coords[1], coords[0]], {
                    radius: 6,
                    color: "orange",
                    fillColor: "orange",
                    fillOpacity: 0.7
                }).addTo(map).bindPopup("Stormwater discharge");
            }
        });
    </script>

{% endblock %}
